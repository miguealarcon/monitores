<!DOCTYPE html>
<html>
<head>

  <!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monitoreo VANCAN 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg:#f4f7fb;
        --card:#ffffff;
        --primary:#0b5ed7;
        --primary-600:#0a58ca;
        --muted:#6b7280;
        --success:#16a34a;
        --danger:#dc3545;
        --radius:10px;
        --shadow: 0 6px 18px rgba(11,94,215,0.08);
        --maxw:1000px;
      }
      *{box-sizing:border-box}
      body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg); margin:0; color:#0f172a}
      .wrap{max-width:var(--maxw); margin:28px auto; padding:20px}
      header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
      .brand{display:flex;gap:12px;align-items:center}
      .brand h1{font-size:18px;margin:0}
      .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
      .grid{display:grid;gap:12px}
      .row{display:flex;gap:12px;align-items:center}
      .muted{color:var(--muted);font-size:13px}

      /* Login */
      #loginCard{max-width:420px;margin:0 auto}
      label{font-size:13px;margin-bottom:6px;display:block}
      input[type=text], input[type=password], input[type=date], select, input[type=number]{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
      .actions{display:flex;gap:10px;align-items:center;margin-top:12px}
      /* Centrar botones dentro de la tarjeta de login */
      #loginCard .actions{justify-content:center}
      button.btn{background:var(--primary);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
      button.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,94,215,0.12)}
      button.btn:disabled{opacity:0.6;cursor:not-allowed}

      /* Form layout */
      .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
      @media (max-width:760px){.form-grid{grid-template-columns:1fr}}
      .form-section{margin-top:16px}
      h2.section{margin:6px 0 10px 0;color:var(--primary)}

      /* Progress */
      .progress{height:10px;background:#e9eef8;border-radius:999px;overflow:hidden}
      .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-600));width:0;transition:width .4s ease}

      /* Summary */
      .summary{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:10px;background:#f8fafc}
      .summary .big{font-size:22px;font-weight:700}

      /* small helpers */
      .small{font-size:13px;color:var(--muted)}
      .fade{transition:all .28s ease;opacity:0;transform:translateY(6px);height:0;overflow:hidden}
      .fade.show{opacity:1;transform:none;height:auto}

      /* toast */
      .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 8px 30px rgba(2,6,23,0.4);display:none}
      .toast.show{display:block}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#0b5ed7"/><path d="M7 12h10M7 8h10M7 16h6" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div>
            <h1>Monitoreo VANCAN 2026</h1>
            <div class="muted">Registro de encuestas y participación</div>
          </div>
        </div>
        <div class="muted">Fecha: <strong id="nowDate"></strong></div>
      </header>

      <main class="grid">
        <section id="loginCard" class="card">
          <h2 style="margin:0 0 8px 0">Acceso</h2>
          <form id="loginForm" aria-label="Formulario de acceso">
            <label for="usuario">Usuario</label>
            <input id="usuario" name="usuario" type="text" required autocomplete="username">
            <label for="password">Contraseña</label>
            <input id="password" name="password" type="password" required autocomplete="current-password">
            <div class="actions">
              <button class="btn" type="submit">Ingresar</button>
            </div>
          </form>
        </section>

        <section id="formArea" class="fade">
          <div class="card" style="display:flex;gap:14px;flex-direction:column">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div>
                <h2 class="section">Registro de Monitoreo</h2>
                <div class="small">Usuario: <span id="userLabel">-</span></div>
              </div>
              <div style="flex:1;max-width:360px">
                <div class="small">Progreso del formulario</div>
                <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
              </div>
            </div>

            <form id="miFormulario">
              <div class="form-grid">
                <div>
                  <label for="microred">Microred</label>
                  <select id="microred" name="microred">
                    <option>ASA</option>
                    <option>Miraflores</option>
                    <option>Socabaya</option>
                  </select>
                </div>
                <div>
                  <label for="vaccine_type">Tipo de vacunación</label>
                  <select id="vaccine_type" name="vaccine_type"><option>general</option><option>barrido</option></select>
                </div>
                <div>
                  <label for="fecha">Fecha</label>
                  <input id="fecha" name="fecha" type="date">
                </div>
                <div>
                  <label>Encargado de la VANCAN</label>
                  <input type="number" name="encargado" min="0">
                </div>
                <div>
                  <label>Inspectores</label>
                  <input type="number" name="inspectores" min="0">
                </div>
                <div>
                  <label>Cadena de frío</label>
                  <input type="number" name="cadena_frio" min="0">
              </div>
                <div><label>Promoción de la salud</label><input type="number" name="promocion" min="0"></div>
                <div><label>Vacunadores</label><input type="number" name="vacunadores" min="0"></div>
                <div><label>Anotadores</label><input type="number" name="anotadores" min="0"></div>
                <div><label>Otros (microred)</label><input type="number" name="otros_microred" min="0"></div>
                <div><label>Especificar otros</label><input type="text" name="otros_microred_desc"></div>
              </div>

              <div class="form-section">
                <h3 class="small" style="margin:0 0 8px 0">Participación adicional</h3>
                <div class="form-grid">
                  <div><label>Municipalidad</label><input type="number" name="municipalidad" min="0"></div>
                  <div><label>Estudiantes</label><input type="number" name="estudiantes" min="0"></div>
                  <div><label>Agentes comunitarios</label><input type="number" name="agentes" min="0"></div>
                  <div><label>Veterinarios particulares</label><input type="number" name="veterinarios" min="0"></div>
                  <div><label>Otras microredes</label><input type="number" name="otras_microredes" min="0"></div>
                  <div><label>UPCH y Monitores</label><input type="number" name="upch_monitores" min="0"></div>
                  <div><label>Otros adicionales</label><input type="number" name="otros_adicionales" min="0"></div>
                  <div><label>Especificar otros</label><input type="text" name="otros_adicionales_desc"></div>
                </div>
              </div>

              <div style="display:flex;gap:12px;align-items:center;margin-top:14px">
                <button class="btn" type="submit" id="saveBtn">Guardar registro</button>
                <button type="button" class="btn ghost" id="resetBtn">Limpiar</button>
                <div style="margin-left:auto;max-width:260px">
                  <div class="summary small" aria-live="polite">
                    <div class="small">Total participantes</div>
                    <div class="big" id="totalParticipants">0</div>
                    <div id="feedback" class="small">Completa los campos para ver el total.</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
      const url = "https://script.google.com/macros/s/AKfycbwIKV5r2LP7Ql1yR58lcD5yJmNPbLHaMzx4vML00uF17lI2Vava0igEFpKTiBP-jEc9/exec";

      // util
      const $ = sel => document.querySelector(sel);
      const nowDate = new Date().toLocaleDateString();
      $('#nowDate').textContent = nowDate;

      // login handling
      const loginForm = $('#loginForm');
      const formArea = $('#formArea');
      const userLabel = $('#userLabel');
      let usuarioActivo = null; let passwordActivo = null;

      function showToast(msg, timeout=3000){ const t = $('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), timeout); }

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = loginForm.querySelector('button[type=submit]'); btn.disabled = true; btn.textContent = 'Validando...';
        const fd = new FormData(loginForm); fd.append('login','true');
        try{
          const res = await fetch(url, {method:'POST', body:fd});
          const contentType = res.headers.get('content-type') || '';
          if (!res.ok) {
            const text = await res.text().catch(()=>'');
            console.error('Respuesta no OK', res.status, text);
            showToast('Error del servidor: ' + res.status);
          } else if (contentType.includes('application/json')) {
            const data = await res.json();
            if(data.success){
              usuarioActivo = fd.get('usuario'); passwordActivo = fd.get('password');
              userLabel.textContent = usuarioActivo;
              loginForm.closest('#loginCard').style.display = 'none';
              formArea.classList.add('show');
              updateProgress(); showToast('Login correcto');
            } else { showToast(data.message || 'Credenciales incorrectas'); }
          } else {
            const text = await res.text().catch(()=>'');
            console.error('Respuesta inesperada al loguear (no JSON):', text);
            showToast('Respuesta inesperada: revisa permisos/CORS del Web App de Apps Script');
          }
        }catch(err){ console.error(err); showToast('Error de conexión'); }
        btn.disabled = false; btn.textContent = 'Ingresar';
      });

      // demo quick access (si existe el botón)
      const demoBtn = $('#demoBtn');
      if (demoBtn) {
        demoBtn.addEventListener('click', ()=>{
          $('#usuario').value = 'demo'; $('#password').value = 'demo';
          $('#loginForm').dispatchEvent(new Event('submit'));
        });
      }

      // form interactivity
      const form = $('#miFormulario');
      const numericFieldsSelector = 'input[type=number]';
      const progressBar = $('#progressBar');
      const totalEl = $('#totalParticipants');
      const feedback = $('#feedback');

      function getNumericInputs(){ return Array.from(form.querySelectorAll(numericFieldsSelector)); }

      function totalParticipants(){
        return getNumericInputs().reduce((s, el)=> s + (Number(el.value) || 0), 0);
      }

      function updateSummary(){
        const total = totalParticipants();
        totalEl.textContent = total;
        feedback.textContent = total>0 ? 'Buen trabajo, registra y continúa.' : 'Aún no hay participantes registrados.';
      }

      function updateProgress(){
        // compute required fields filled percent
        const required = Array.from(form.querySelectorAll('[required], input[type=date]'));
        const filled = required.filter(f=> !!f.value).length;
        const pct = Math.round((filled / Math.max(required.length,1)) * 100);
        progressBar.style.width = pct + '%';
      }

      // listen inputs
      form.addEventListener('input', ()=>{ updateSummary(); updateProgress(); });
      document.addEventListener('DOMContentLoaded', ()=>{ updateSummary(); updateProgress(); });

      // reset
      $('#resetBtn').addEventListener('click', ()=>{ form.reset(); updateSummary(); updateProgress(); showToast('Formulario limpiado'); });

      // submit
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        // Antes de crear FormData, asegurar que campos numéricos vacíos se conviertan a 0
        const numericInputs = getNumericInputs();
        numericInputs.forEach(inp => {
          if (inp.value === '' || inp.value == null) inp.value = '0';
        });

        const saveBtn = $('#saveBtn'); saveBtn.disabled = true; saveBtn.textContent = 'Guardando...';
        const formData = new FormData(form);
        formData.append('usuario', usuarioActivo || 'anónimo');
        formData.append('password', passwordActivo || '');
        try{
          const res = await fetch(url, {method:'POST', body:formData});
          const contentType = res.headers.get('content-type') || '';
          if (!res.ok) {
            const text = await res.text().catch(()=>'');
            console.error('Error guardar (no OK):', res.status, text);
            showToast('Error del servidor: ' + res.status);
          } else if (contentType.includes('application/json')) {
            const data = await res.json();
            showToast(data.message || 'Registro guardado');
            // Si el guardado fue exitoso, limpiar el formulario para una nueva entrada
            if (data.success) {
              form.reset();
              updateSummary();
              updateProgress();
              const first = form.querySelector('select, input, textarea');
              if (first) first.focus();
            }
          } else {
            const text = await res.text().catch(()=>'');
            console.error('Respuesta inesperada al guardar (no JSON):', text);
            showToast('Respuesta inesperada: revisa permisos/CORS del Web App de Apps Script');
          }
        }catch(err){ console.error(err); showToast('Error al guardar (conexión)'); }
        saveBtn.disabled = false; saveBtn.textContent = 'Guardar registro';
      });
    </script>
  </body>
  </html>

